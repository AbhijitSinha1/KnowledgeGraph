<html>

<head>
  <title>Knowledge Graph</title>
  <style type="text/css">
  </style>
</head>

<body>
  <input placeholder="Term" id="term" />
  <input placeholder="Depth" id="depth" type="number" />
  <button id="search">OK</button>
  <span>Inspired by <a target="blank"
      href="https://medium.com/applied-data-science/the-google-vs-trick-618c8fd5359f">this medium post</a></span>
  <div id="container"></div>
  <script src="/js/vis-network.min.js"></script>
  <script src="/js/sha256.min.js"></script>
  <script>
    document.getElementById('search').addEventListener('click', async () => {
      const term = document.getElementById('term').value;
      const depth = document.getElementById('depth').value;
      const { message } = await (await fetch(`/api/v1/knowledge?term=${term}&depth=${depth}`)).json();
      const nodeObj = {}, edgeObj = {};
      let id = 0;

      for (const node in message) {
        if (!nodeObj[node]) {
          nodeObj[node] = id++;
        }
        for (const peer in message[node]) {
          if (edgeObj[peer] && edgeObj[peer][node]) {
            edgeObj[peer][node] += message[node][peer];
          } else {
            if (!edgeObj[node]) {
              edgeObj[node] = {};
            }
            edgeObj[node][peer] = message[node][peer];
          }
          if (!nodeObj[peer]) {
            nodeObj[peer] = id++;
          }
        }
      }

      const nodeList = [], edgeList = [];

      for (const node in nodeObj) {
        nodeList.push({
          id: nodeObj[node],
          label: node
        })
      }

      for (const from in message) {
        for (const to in message[from]) {
          if (!edgeObj[from] || !edgeObj[from][to]) {
            continue;
          }
          edgeList.push({
            from: nodeObj[from],
            to: nodeObj[to],
            width: edgeObj[from][to]
          })
        }
      }

      // create an array with nodes
      var nodes = new vis.DataSet(nodeList);

      // create an array with edges
      var edges = new vis.DataSet(edgeList);

      // create a network
      var container = document.getElementById('container');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {};
      var network = new vis.Network(container, data, options);

      network.on('click', function (properties) {
        var ids = properties.nodes;
        var clickedNodes = nodes.get(ids);
        const url = `https://www.google.com/search?q=${clickedNodes[0].label}`;
        window.open(url, '_blank');
      });

      network.on('oncontext', function (params) {
        params.event.preventDefault();
        const id = network.getNodeAt(params.pointer.DOM);
        const node = nodes.get(id);
        console.log(node.label);
      })
    });
  </script>
</body>

</html>